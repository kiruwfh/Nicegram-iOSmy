name: Build Telegram IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
      continue-on-error: true
        
    - name: Try manual submodules
      run: |
        git submodule update --init --recursive || echo "Some submodules failed"
      continue-on-error: true
        
    - name: Setup Xcode 15.4
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: Check Xcode
      run: |
        xcodebuild -version
        xcode-select -p
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config yasm
        pip3 install pyyaml
        
    - name: Check project structure
      run: |
        echo "=== Root directory ==="
        ls -la
        echo ""
        echo "=== Build system ==="
        ls -la build-system/ || echo "No build-system"
        echo ""
        echo "=== Looking for Make.py ==="
        find . -name "Make.py" -type f 2>/dev/null | head -5
        echo ""
        echo "=== Looking for xcworkspace ==="
        find . -name "*.xcworkspace" -type d 2>/dev/null | head -5
        echo ""
        echo "=== Looking for xcodeproj ==="
        find . -name "*.xcodeproj" -type d 2>/dev/null | head -5
        
    - name: Try generate project
      run: |
        if [ -f "build-system/Make/Make.py" ]; then
          echo "Found Make.py, checking requirements..."
          cat build-system/Make/requirements.txt 2>/dev/null || echo "No requirements.txt"
          
          # Create config
          cat > my-config.json << 'CONF'
        {
          "bundle_id": "org.nicegram.Nicegram-iOS",
          "api_id": "8",
          "api_hash": "7245de8e747a0d6fbe11f7cc14fcc0bb",
          "team_id": "XXXXXXXXXX",
          "app_center_id": "",
          "is_internal_build": false,
          "is_appstore_build": false,
          "appstore_id": "0",
          "app_specific_url_scheme": "nicegram"
        }
        CONF
          
          python3 build-system/Make/Make.py --help || echo "Make.py help failed"
          
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-cache" \
            generateProject \
            --configurationPath=my-config.json \
            --disableProvisioningProfiles 2>&1 | tee generate.log || echo "Generate failed, check log"
        else
          echo "Make.py not found!"
        fi
      continue-on-error: true
      
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: diagnostic-logs
        path: |
          *.log
          my-config.json
        if-no-files-found: warn

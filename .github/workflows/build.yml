name: Build Telegram IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: Setup Git LFS
      run: |
        git lfs install
        git lfs pull
        
    - name: Init submodules manually
      run: |
        # Инициализируем только публичные submodules
        git submodule init
        git submodule update --recursive --depth 1 || true
        
        # Если tgcalls приватный - клонируем публичную альтернативу
        if [ ! -d "submodules/TgVoipWebrtc/tgcalls/Sources" ]; then
          rm -rf submodules/TgVoipWebrtc/tgcalls
          git clone --depth 1 https://github.com/nicegram/nicegram-tgcalls.git submodules/TgVoipWebrtc/tgcalls || true
        fi
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        brew install cmake ninja pkg-config
        pip3 install -r build-system/Make/requirements.txt || pip3 install pyyaml
        
    - name: Create minimal config
      run: |
        cat > build-config.json << 'EOF'
        {
          "bundle_id": "org.nicegram.Nicegram-iOS",
          "api_id": "8",
          "api_hash": "7245de8e747a0d6fbe11f7cc14fcc0bb",
          "team_id": "XXXXXXXXXX",
          "app_center_id": "",
          "is_internal_build": false,
          "is_appstore_build": false,
          "appstore_id": "0",
          "app_specific_url_scheme": "nicegram"
        }
        EOF
        
    - name: Generate project
      run: |
        python3 build-system/Make/Make.py \
          --cacheDir="$HOME/bazel-cache" \
          generateProject \
          --configurationPath=build-config.json \
          --disableProvisioningProfiles \
          --xcodeManagedCodesigning || echo "Project generation had warnings"
          
    - name: Build unsigned IPA
      run: |
        # Попробуем собрать через xcodebuild
        if [ -f "Telegram.xcworkspace" ] || [ -d "Telegram.xcworkspace" ]; then
          xcodebuild -workspace Telegram.xcworkspace \
            -scheme Nicegram \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/App.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" || echo "Build completed with warnings"
        else
          echo "Workspace not found, trying xcodeproj..."
          xcodebuild -list
        fi
        
    - name: Package IPA
      run: |
        mkdir -p build/Payload
        
        # Найти .app файл
        APP_PATH=$(find build -name "*.app" -type d | head -1)
        
        if [ -n "$APP_PATH" ]; then
          cp -r "$APP_PATH" build/Payload/
          cd build
          zip -r Telegram-unsigned.ipa Payload
          echo "IPA created successfully!"
        else
          echo "No .app found, listing build directory:"
          find build -type f -name "*" | head -50
        fi
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Telegram-GhostMode
        path: build/*.ipa
        if-no-files-found: warn
        
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/
          *.log
